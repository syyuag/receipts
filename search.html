<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hello, Vegan!</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/sidebar.css">
</head>
    <body>
        <div class="container">
            <div class="jumbotron">
              <p class="text-center">
                <a href="main.html">
                    <img src="images/i128x128.png" class="img-responsive" style="margin:0 auto;" alt="Responsive image">                
                </a>
              </p>
              <h1 class="text-center">Hello World!</h1>
              <p class="text-center">
                A simple hello could lead to a million things
              </p>
            </div>

            <div class="row justify-content-center">
                <div class="col-xs-6" style="width: 40%;">
                    <input type="search" id="restaurantInput" class="form-control input-lg" placeholder="Please enter the restaurant name" style="display: none;" onchange="searchRestaurantDemo(this.value)">
                    <h6 id="restSearch"></h6>
                    <label id="searchBtn" class="btn btn-success my-2 btn-default btn-block btn-lg" " onClick="(function s(){
                        document.getElementById('restaurantInput').style.display = 'block';
                        console.log('clicked');
                    })()">
                    Search Restaurant
                  </label>
                </div>
            </div>

            <div > 
                <button id="gluten_free" onclick="btnClick(this)" class="btn btn-primary">Gluten Free</button>
                <button id="egg_free" onclick="btnClick(this)" class="btn btn-primary">Egg Free</button>
                <button id="dairy_free" onclick="btnClick(this)" class="btn btn-primary">Dairy Free</button>
                <button id="treenut_free" onclick="btnClick(this)" class="btn btn-primary">Treenut Free</button>
                <button id="peanut_free" onclick="btnClick(this)" class="btn btn-primary">Peanut Free</button>
                <button id="soy_free" onclick="btnClick(this)" class="btn btn-primary">Soy Free</button>
                <button id="raw" onclick="btnClick(this)" class="btn btn-primary">Raw</button>
                <button id="vegan" onclick="btnClick(this)" class="btn btn-primary">Vegan</button>
                <button id="buddhist_friendly" onclick="btnClick(this)" class="btn btn-primary">Buddhist Friendly</button>
                <button id="all_natural" onclick="btnClick(this)" class="btn btn-primary">All Natural</button>
                <button id="clear" onclick="clearTag()" class="btn btn-danger">Clear All</button>
            </div>


            <div id="mapSection">
                <div id="sidebar-wrapper">                   
                    <div id="toggle-btn" onclick="toggleSidebar()">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <div id="sidebar">            
                        <h3 id="restaurantName">Restaurant</h3>
                        <h4 id="restName"></h4>
                        <hr>
                        <h3 id="restaurantLocation">location</h3>
                        <h4 id="restLocation"></h4>
                        <h3>Dishes</h3>
                        <div id="restaurnatDish">                                
                            <h5>Dish</h5>
                            <div id="slideContainer">
                                <h6 id="dishName"></h6>
                                <img src="" id="dishImage" style='width: 150px;'>
                                <div style="width: 150px;overflow: auto;">
                                    <h5>tags</h5>
                                    <h6 id="tagString"></h6>
                                </div>
                                <div class="dotSection">
                                    <span class="dot"></span>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
                <div id="map" style="width: 100%; height: 70vh;"></div>
            </div>

            <div class="row justify-content-center">
                <a href="main.html">
                  <label id="back"class="btn btn-primary my-2 btn-default btn-block btn-lg" style="cursor: pointer;">Back to Main</label>
                </a>
            </div>
        </div>
    </body>

        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-analytics.js"></script>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyCSVVuOWRkUqETWCJ_lvkVViCn3kJ0sW20",
                authDomain: "evernote-95214.firebaseapp.com",
                databaseURL: "https://evernote-95214.firebaseio.com",
                projectId: "evernote-95214",
                storageBucket: "evernote-95214.appspot.com",
                messagingSenderId: "570103698695",
                appId: "1:570103698695:web:e82b8eacc896e8ccbd21a2",
                measurementId: "G-YLS51K3GQZ"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            var storageRef = firebase.storage().ref();
            var storage = firebase.storage();

            //states
            var isGlutenShown = false;
            var isEggShown = false;
            var isDairyShown = false;
            var isTreenutShown = false;
            var isPeanutShown = false;
            var isSoyShown = false;
            var isRawShown = false;
            var isVeganShown = false;
            var isBuddhistFriendlyShown = false;
            var isAllNaturalShown = false;

            //marker list
            let markers = [];
            let showing = [];
            let newShowing = [];
            let selected = [];
            let selectedRegex = [];

            var isSideOpen = false;

            function stopAnimation(marker) {
                setTimeout(function () {
                    marker.setAnimation(null);
                }, 3000);
            }

            function isInArea(position, area) {
                let x = position[0] - area.center[0];
                let y = position[1] - area.center[1];
                let distance = Math.sqrt((x * x) + (y * y));
                return(distance < area.radius);
            }

            function searchRestaurantDemo(input) {
                var count = 0; 
                var str = input.toLowerCase().replace(/\s/g,'');                   
                
                markers.forEach(item => {
                    var pattern = new RegExp(item.name);
                    if(pattern.test(str)){
                    count++;
                    item.marker.setAnimation(google.maps.Animation.BOUNCE); 
                    stopAnimation(item.marker);     
                    item.marker.setIcon('http://maps.google.com/mapfiles/ms/micons/blue-dot.png');
                    map.setCenter(item.marker.position);
                    item.marker.setVisible(true);
                    }else{
                    item.marker.setVisible(false);
                    item.marker.setIcon('http://maps.gstatic.com/mapfiles/markers2/marker_greenV.png');
                    }
                })     
                document.getElementById('restSearch').innerText = count + ' restaurant found';
                if(count > 0){
                    document.getElementById('restSearch').style.color = 'rgb(0,255,0)'
                }else{
                    document.getElementById('restSearch').style.color = 'rgb(255,0,0)'
                    markers.forEach(item => item.marker.setVisible(true));
                };
            }

            function toggleSidebar() {
                document.getElementById("sidebar-wrapper").classList.toggle('open');
                isSideOpen = !isSideOpen;
                console.log('ckicked')
            }

           /* $( document ).ready(function() {
                var autocomplete;
                autocomplete = new google.maps.places.Autocomplete((document.getElementById('restaurantInput')), {
                    types: ['address']
                })

                google.maps.event.addListener(autocomplete, )
            });*/

            function initAutocomplete() {
                // Create the search box and link it to the UI element.
                const input = document.getElementById("restaurnatInput");
                const searchBox = new google.maps.places.SearchBox(input);
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                // Bias the SearchBox results towards current map's viewport.
                map.addListener("bounds_changed", () => {
                    searchBox.setBounds(map.getBounds());
                });
                let markers = [];
                // Listen for the event fired when the user selects a prediction and retrieve
                // more details for that place.
                searchBox.addListener("places_changed", () => {
                    const places = searchBox.getPlaces();
                    if (places.length == 0) {
                    return;
                    }
                    // For each place, get the icon, name and location.
                    const bounds = new google.maps.LatLngBounds();
                    places.forEach(place => {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                        return;
                    }
                    const icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25)
                    };
                    // Create a marker for each place.
                    markers.push(
                        new google.maps.Marker({
                        map,
                        icon,
                        title: place.name,
                        position: place.geometry.location
                        })
                    );
                    });
                    map.fitBounds(bounds);
                });
            }
            

            function btnClick(btn) {
                var isClicked;
                var tag;
                switch(btn.id){
                    case "gluten_free":
                        isGlutenShown = !isGlutenShown;
                        isClicked = isGlutenShown;
                        tag = /gluten_free/;
                        break;
                    case "egg_free":
                        isEggShown = !isEggShown;
                        isClicked = isEggShown;
                        tag = /egg_free/;
                        break;
                    case "dairy_free":
                        isDairyShown = !isDairyShown;
                        isClicked = isDairyShown;
                        tag = /dairy_free/;
                        break;
                    case "treenut_free":
                        isTreenutShown = !isTreenutShown;
                        isClicked = isTreenutShown;
                        tag = /treenut_free/;
                        break;
                    case "peanut_free":
                        isPeanutShown = !isPeanutShown;
                        isClicked = isPeanutShown;
                        tag = /peanut_free/;
                        break;
                    case "soy_free":
                        isSoyShown = !isSoyShown;
                        isClicked = isSoyShown;
                        tag = /soy_free/;
                        break;
                    case "raw":
                        isRawShown = !isRawShown;
                        isClicked = isRawShown;
                        tag = /raw/;
                        break;
                    case "vegan":
                        isVeganShown = !isVeganShown;
                        isClicked = isVeganShown;
                        tag = /vegan/;
                        break;
                    case "buddhist_friendly":
                        isBuddhistFriendlyShown = !isBuddhistFriendlyShown;
                        isClicked = isBuddhistFriendlyShown;
                        tag = /buddhist_friendly/;
                        break;
                    case "all_natural":
                        isAllNaturalShown = !isAllNaturalShown;
                        isClicked = isAllNaturalShown;
                        tag = /all_natural/;
                        break;
                }
                if(isClicked) {
                    btn.style.backgroundColor = 'green';
                    selected.push(btn.id);
                    selectedRegex.push(tag);     
                    filter(tag);
                }else{
                    btn.style = '';
                    var i = selected.indexOf(btn.id);
                    selected.splice(i, 1);
                    selectedRegex.splice(i, 1);   
                    deselect();
                }
            }

            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 22.3, lng: 114.16},
                    zoom: 12,
                    styles: [{
                    featureType: 'poi',
                    stylers: [{ visibility: 'off' }]  // Turn off points of interest.
                    }, {
                    featureType: 'transit.station',
                    stylers: [{ visibility: 'off' }]  // Turn off bus stations, train stations, etc.
                    }],
                    disableDoubleClickZoom: true,
                    streetViewControl: false
                });
                console.log('initializing map');
                db.collection('restaurants').get().then((snapshot) => {
                    snapshot.docs.forEach(doc => {
                    var restaurantData = doc.data();
                    console.log(restaurantData.location);
                    addMarker(restaurantData, doc.id);
                    });
                }); 
                console.log(showing);
            }

            function addMarker(restaurant, restaurantName) {                    
                var name = restaurantName;         
                let lat = restaurant.location[0];
                let lng =  restaurant.location[1];
                var marker = new google.maps.Marker({
                    position: {lat, lng},
                    map: map,
                    icon: 'http://maps.gstatic.com/mapfiles/markers2/marker_greenV.png',
                    animation: google.maps.Animation.DROP
                });     

                marker.addListener('click', function() {
                    if(!isSideOpen){
                        document.getElementById("sidebar-wrapper").classList.toggle('open');
                        isSideOpen = !isSideOpen;
                        console.log('ckicked')
                        /*var infowindow = new google.maps.InfoWindow({
                            content:'<div><h6> Restaurant: ' +
                                    name +
                                    '</h6><h6> Dish: ' +
                                    restaurant.dish +
                                    '<h6></div>' +
                                    '<div>' +
                                    img +
                                    '</div>' +
                                    '<div style="width: 150px;overflow: auto;"><h6>Tags : ' +
                                    tagString +
                                    '<h6></div>'
                        });
                        infowindow.open(map, marker);*/
                    }
                       // $('.dish').remove();
                       // $('.photo').remove();
                       // $('.tags').remove();
                        $('#dishSection').remove();
                        document.getElementById('restName').innerText = name;
                        document.getElementById('restLocation').innerText = restaurant.location;
                        var dishSection = document.createElement("div")
                        dishSection.id = "dishSection";
                        document.getElementById("slideContainer").appendChild(dishSection);
                        restaurant.dishes.forEach((dishes) => {                        
                        var name = document.createElement("h5");
                        name.innerText = dishes.dish;
                        document.getElementById('dishSection').appendChild(name)
                        var photo = document.createElement("img");
                        photo.src = dishes.fileURL;
                        photo.style.width = '150px' 
                        document.getElementById('dishSection').appendChild(photo);                
                        var tags = dishes.tags;
                        var tagString = '';
                        var makeTagString = tags.forEach((tags) => {
                            if(tags.value == true){
                                tagString += '#' + tags.name + '  ';
                            };
                        });
                        var tag = document.createElement('h6');
                        tag.innerText = tagString;
                        document.getElementById('dishSection').appendChild(tag); 
                    }) 

                        //document.getElementById('dishName').innerText = restaurant.dish;
                       // document.getElementById('dishImage').src = restaurant.fileURL;
                       // document.getElementById('tagString').innerText = tagString;
                        this.setAnimation(google.maps.Animation.BOUNCE); 
                        stopAnimation(this);     
                });
                markers.push({marker, name});
            }

            function showList(tag) {
                hideAllMarkers();
                console.log('show', tag);
                var idList;
                var list = db.collection('tagLists').doc(tag).get().then((doc) => {
                    idList = doc.data().docID;                
                    console.log(idList);
                    idList.forEach((id) => {
                        var d = db.collection('receipts').doc(id).get().then((rdoc) => {
                            addMarker(rdoc.data());
                        });
                    });
                })
            }

            function hideAllMarkers() {
                markers.forEach(item => item.setVisible(false));
            }

            function showAllMarkers() {
                markers.forEach(item => item.setVisible(true));
            }

            function filter(tag) {
                console.log('filtering', tag);
                hideAllMarkers();                              
                    if(showing.length == 0){                    
                        markers.forEach(item => {  
                            if(tag.test(item.getTitle())){
                                console.log(true);
                                item.setVisible(true);                        
                                showing.push(item);
                            }
                        })
                        console.log(showing.length);
                    }else{
                        showing.forEach(item => {
                            if(tag.test(item.getTitle())){                            
                                console.log(true);        
                                item.setVisible(true);                        
                                newShowing.push(item);
                            }
                        })
                        showing = newShowing;
                        newShowing = [];
                    }
                console.log(selected);
                console.log(selectedRegex);
            }

            function deselect() {
                console.log(selected);
                console.log(selectedRegex);
                showing = [];
                if(selectedRegex.length != 0){
                    selectedRegex.forEach(item => {
                    filter(item);
                    });  
                }else{
                    showAllMarkers();
                }                
            }

            function clearTag() {
                showAllMarkers();
                selected = [];
                selectedRegex = [];
                isGlutenShown = false;
                isEggShown = false;
                isDairyShown = false;
                isTreenutShown = false;
                isPeanutShown = false;
                isSoyShown = false;
                isRawShown = false;
                isVeganShown = false;
                isBuddhistFriendlyShown = false;
                isAllNaturalShown = false;

                document.getElementById('gluten_free').style = '';
                document.getElementById('egg_free').style = '';
                document.getElementById('dairy_free').style = '';
                document.getElementById('treenut_free').style = '';
                document.getElementById('peanut_free').style = '';
                document.getElementById('soy_free').style = '';
                document.getElementById('raw').style = '';
                document.getElementById('vegan').style = '';
                document.getElementById('buddhist_friendly').style = '';
                document.getElementById('all_natural').style = '';
            }

        </script>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAEJpg61U3rDVLKE9A0MZ-1i7F1FezKpTQ
            &callback=initMap&libraries=visualization,places">
        </script>
        <script src="js/JIC.min.js" type="text/javascript"></script>
        <script src="js/jquery-3.5.1.min.js"></script>

    
</html>